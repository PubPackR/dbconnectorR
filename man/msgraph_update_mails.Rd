% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/msgraph_mails.R
\name{msgraph_update_mails}
\alias{msgraph_update_mails}
\title{Update Mails from MS Graph API}
\usage{
msgraph_update_mails(
  con,
  msgraph_keys,
  start_date = NULL,
  user_filter = NULL,
  max_retries = 3
)
}
\arguments{
\item{con}{Database connection object (pool or DBI connection).
Must have access to tables: raw.msgraph_users, raw.msgraph_mails,
raw.msgraph_contacts, raw.msgraph_mail_recipients, raw.msgraph_mail_senders}

\item{msgraph_keys}{List containing MS Graph API credentials with elements:
\itemize{
\item tenant_id: Azure AD tenant ID
\item client_id: Azure AD client/application ID
\item client_secret: Azure AD client secret
Note: This is NOT keys$msgraph from authentication_process(). You need to
construct this list manually with all three elements.
}}

\item{start_date}{Optional. Date to start mail retrieval from.
If NULL, automatically determined from last update in database.
Format: Date object or character string in format "YYYY-MM-DD"}

\item{user_filter}{Optional. Character vector of user IDs to process.
If NULL, all internal non-deleted users are processed.}

\item{max_retries}{Integer. Maximum number of retry attempts for users
with empty results. Default: 3. Set to 1 to disable retries.}
}
\value{
Invisible NULL. Function is called for side effects (database updates).
}
\description{
Main function to retrieve and process mail data from Microsoft Graph API
and store it in PostgreSQL database. Handles mail content, contacts,
senders, and recipients.
}
\details{
This function:
\itemize{
\item Retrieves mails from MS Graph for all internal users
\item Converts HTML mail bodies to plaintext
\item Updates mail, contact, sender, and recipient tables in database
\item Implements retry logic for users with empty results
}
}
\examples{
\dontrun{
# Basic usage with automatic start date
msgraph_update_mails(
  con,
  msgraph_keys = list(
    tenant_id = "your-tenant-id",
    client_id = "your-client-id",
    client_secret = keys$msgraph
  )
)

# Specify custom start date
msgraph_update_mails(
  con,
  msgraph_keys = list(
    tenant_id = "your-tenant-id",
    client_id = "your-client-id",
    client_secret = keys$msgraph
  ),
  start_date = "2025-01-01"
)

# Process specific users only
msgraph_update_mails(
  con,
  msgraph_keys = list(
    tenant_id = "your-tenant-id",
    client_id = "your-client-id",
    client_secret = keys$msgraph
  ),
  user_filter = c("user-id-1", "user-id-2")
)
}

}
